<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è²“å’ªå­˜éŒ¢ç­’">
    <meta name="theme-color" content="#FFB7B2">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/616/616430.png">
    
    <title>ğŸ± å¤¢æƒ³è²“å’ªå­˜éŒ¢æ‰‹å¸³ V2.5</title>
    <style>
        :root { --cat-main: #FFB7B2; --cat-bg: #fffaf0; --cat-dark: #5D4037; --cat-gray: #D7CCC8; --cat-red: #ff7675; --cat-green: #55efc4; --cat-blue: #74b9ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, "SF Pro Text", sans-serif; 
            background-color: var(--cat-bg); 
            color: var(--cat-dark); 
            margin: 0; 
            padding: env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 100px) 0; 
        }

        .container { max-width: 450px; margin: 0 auto; padding: 20px; }
        .text-center { text-align: center; }

        /* è²“å’ªäº’å‹•å€ */
        .cat-interaction { text-align: center; margin-bottom: 20px; position: relative; cursor: pointer; height: 100px; display: flex; align-items: center; justify-content: center; }
        .cat-emoji { font-size: 60px; z-index: 2; transition: transform 0.2s; }
        .cat-emoji:active { transform: scale(1.2); }
        .bubble { position: absolute; background: white; border: 2px solid var(--cat-dark); border-radius: 15px; padding: 8px 12px; font-size: 14px; font-weight: bold; top: 0px; left: 58%; display: none; z-index: 10; width: 140px; box-shadow: 4px 4px 0 var(--cat-gray); }

        /* å¡ç‰‡å…ƒä»¶ */
        .cat-card { background: #ffffff; border: 3px solid var(--cat-dark); box-shadow: 6px 6px 0px var(--cat-gray); border-radius: 20px; margin-bottom: 20px; padding: 16px; position: relative; }
        .status-alert { padding: 12px; border-radius: 15px; margin-bottom: 20px; font-weight: bold; font-size: 14px; border: 2px solid var(--cat-dark); text-align: center; box-shadow: 4px 4px 0 var(--cat-gray); }

        /* é€²åº¦æ¢ */
        .prog-container { background: #EFEBE9; height: 26px; border-radius: 13px; border: 2px solid var(--cat-dark); overflow: hidden; margin: 8px 0; position: relative; }
        .prog-fill { height: 100%; transition: width 1s ease; background: var(--cat-main); border-right: 2px solid var(--cat-dark); }
        .prog-text { position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold; line-height: 22px; z-index: 5; }

        /* è¨˜å¸³è¼¸å…¥ */
        input { width: 100%; border: 2px solid var(--cat-dark); border-radius: 10px; padding: 10px; font-size: 16px; outline: none; background: white; }
        .btn-main { background: var(--cat-main); border: 2px solid var(--cat-dark); box-shadow: 0 4px 0px var(--cat-dark); font-weight: bold; color: white; border-radius: 12px; padding: 14px; width: 100%; cursor: pointer; margin-top: 10px; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0px var(--cat-dark); }

        /* å°èˆªåˆ— */
        .nav-bar { position: fixed; bottom: 25px; left: 15px; right: 15px; background: rgba(255, 255, 255, 0.95); border: 3px solid var(--cat-dark); box-shadow: 0 8px 0px var(--cat-gray); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; border-radius: 30px; }
        .nav-item { border: none; background: none; cursor: pointer; padding: 8px 15px; }
        .nav-icon { font-size: 24px; }
        .nav-item.active .nav-icon { background: var(--cat-main); border-radius: 12px; border: 2px solid var(--cat-dark); padding: 5px 12px; }

        /* è¨­å®šé æ ¼ä½ */
        .setup-item { background: #fdfdfd; padding: 15px; border: 2px solid var(--cat-dark); border-radius: 15px; margin-bottom: 20px; box-shadow: 4px 4px 0 #eee; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .setup-label { font-size: 11px; font-weight: bold; color: var(--cat-dark); margin-bottom: 4px; display: block; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 20px; border: 3px solid var(--cat-dark); padding: 20px; max-height: 80vh; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 12px 0; }

        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-home" class="page active">
        <div class="cat-interaction" onclick="cheerUp()">
            <div id="cat-bubble" class="bubble">å–µå—šï¼Ÿ</div>
            <span id="cat-avatar" class="cat-emoji">ğŸ’¤</span>
        </div>
        <h1 id="display-title" class="text-center" style="color: #FF748C; margin: 0 0 15px 0;">æˆ‘çš„å­˜éŒ¢è¨ˆç•«</h1>
        <div id="monthly-status" class="status-alert"></div>
        <div id="jarList"></div>
        <div class="cat-card" style="background: #fff5f5;">
            <h3 class="text-center" style="margin:0 0 15px 0">ğŸŸ é¤µé£ŸéŒ¢ç­’</h3>
            <div id="inputGrid" style="display: grid; gap: 12px;"></div>
            <button onclick="saveRecord()" class="btn-main">ç¢ºèªå­˜å…¥ ğŸŸ</button>
        </div>
    </div>

    <div id="page-settings" class="page">
        <h2 class="text-center">âš™ï¸ è¨­å®šæ ¸å¿ƒ</h2>
        <div class="cat-card">
            <label class="setup-label">âœï¸ è¨ˆç•«æ¨™é¡Œ</label>
            <input type="text" id="set-title" style="margin-bottom:20px">
            
            <div id="jarSetupArea"></div>
            <button onclick="addJarSetup()" class="btn-main" style="background:#fff; color:var(--cat-dark); border-style:dashed;">+ å¢åŠ ç¨ç«‹æ™‚ç¨‹éŒ¢ç­’</button>
            <button onclick="applySettings()" class="btn-main" style="background:var(--cat-green); margin-top:20px;">å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>

            <div style="margin-top:30px; display: flex; justify-content: space-between;">
                <button onclick="exportData()" style="background:none; border:none; color:#999; text-decoration:underline; font-size:12px;">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                <button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:#999; text-decoration:underline; font-size:12px;">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
            </div>
        </div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0">å­˜æ¬¾æ˜ç´°</h3>
        <div id="modalHistoryList"></div>
        <button class="btn-main" onclick="closeModal()" style="background:var(--cat-gray)">é—œé–‰</button>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="showPage('home', this)"><span class="nav-icon">ğŸ </span></button>
    <button class="nav-item" onclick="showPage('settings', this)"><span class="nav-icon">âš™ï¸</span></button>
</nav>

<script>
    const DB_KEY = 'cat_final_v11';
    let store = JSON.parse(localStorage.getItem(DB_KEY)) || {
        config: { title: "æˆ‘çš„å¤¢æƒ³æœ¬", jars: [] },
        history: []
    };

    function updateUI() {
        document.getElementById('display-title').innerText = store.config.title;
        const list = document.getElementById('jarList');
        const grid = document.getElementById('inputGrid');
        list.innerHTML = ""; grid.innerHTML = "";
        
        let totalPct = 0;
        const now = new Date();

        store.config.jars.forEach(jar => {
            const currentAmount = store.history.filter(h => h.jarName === jar.name).reduce((s, h) => s + h.amount, 0);
            const start = new Date(jar.start);
            const end = new Date(jar.end);
            
            // è¨ˆç®—æœˆä»½å·® (åŒ…å«é ­å°¾)
            const totalM = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
            const passedM = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
            const safePassed = Math.max(0, Math.min(passedM, totalM - 1));
            const mLeft = Math.max(0, totalM - (safePassed + 1));

            const pct = jar.goal > 0 ? Math.min(Math.round((currentAmount / jar.goal) * 100), 100) : 0;
            totalPct += pct;

            const targetNow = Math.round((jar.goal / totalM) * (safePassed + 1));
            const gap = targetNow - currentAmount;

            list.innerHTML += `
                <div class="cat-card" onclick="openHistory('${jar.name}')">
                    <div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>${jar.name}</span>
                        <span>${jar.unit}${currentAmount.toLocaleString()} / ${jar.goal.toLocaleString()}</span>
                    </div>
                    <div style="font-size:10px; color:#999; margin: 4px 0;">ğŸ“… å‰© ${mLeft} å€‹æœˆ (åˆ°æœŸ: ${jar.end})</div>
                    <div class="prog-container"><div class="prog-text">${pct}%</div><div class="prog-fill" style="width:${pct}%"></div></div>
                    <div style="font-size:11px; display:flex; justify-content:space-between; margin-top:5px;">
                        <span style="color:#888;">æ‡‰å­˜: ${jar.unit}${targetNow.toLocaleString()}</span>
                        <span style="color:${gap > 0 ? 'var(--cat-red)' : 'var(--cat-green)'}; font-weight:bold;">${gap > 0 ? 'é‚„å·® ' + gap.toLocaleString() : 'è¶…æ¨™ âœ¨'}</span>
                    </div>
                </div>`;
            
            grid.innerHTML += `<div><small style="font-size:11px; font-weight:bold;">${jar.name}</small><input type="number" class="record-input" data-name="${jar.name}" placeholder="è¼¸å…¥å­˜æ¬¾é‡‘é¡"></div>`;
        });

        // è²“å’ªèˆ‡é€²åº¦ç‹€æ…‹
        const avg = totalPct / (store.config.jars.length || 1);
        document.getElementById('cat-avatar').innerText = avg >= 100 ? "ğŸŠ" : avg >= 80 ? "ğŸ˜»" : avg >= 40 ? "ğŸ˜º" : avg > 0 ? "ğŸ±" : "ğŸ’¤";
        const curM = now.toISOString().slice(0,7);
        const hasSaved = store.history.some(h => h.time.startsWith(curM));
        const alertEl = document.getElementById('monthly-status');
        alertEl.style.backgroundColor = hasSaved ? "#b2f2bb" : "#ffeaa7";
        alertEl.innerText = hasSaved ? "âœ¨ å–µï¼æœ¬æœˆå·²ç¶“å­˜éŒ¢äº†ï¼Œå¤ªæ£’äº†ï¼" : "âš ï¸ å–µå—šï¼æœ¬æœˆé‚„æ²’é¤µé£Ÿï¼ŒéŒ¢ç­’é¤“æ‰äº†ã€‚";
    }

    function saveRecord() {
        let any = false;
        document.querySelectorAll('.record-input').forEach(input => {
            const val = Number(input.value);
            if(val !== 0) {
                store.history.unshift({ id: Date.now() + Math.random(), jarName: input.dataset.name, amount: val, time: new Date().toISOString() });
                any = true;
            }
            input.value = "";
        });
        if(any) { saveToDB(); updateUI(); alert("å­˜å…¥æˆåŠŸï¼"); }
    }

    function openHistory(name) {
        document.getElementById('modalTitle').innerText = `ğŸ¾ ${name} æ˜ç´°`;
        const hList = document.getElementById('modalHistoryList');
        const filtered = store.history.filter(h => h.jarName === name);
        hList.innerHTML = filtered.length ? filtered.map(h => `
            <div class="history-item">
                <div>
                    <div style="font-weight:bold;">+ ${h.amount.toLocaleString()}</div>
                    <div style="font-size:11px; color:#999;">${new Date(h.time).toLocaleDateString()}</div>
                </div>
                <button onclick="deleteRecord(${h.id})" style="background:none; border:none; color:red; font-size:20px; cursor:pointer;">ğŸ—‘ï¸</button>
            </div>
        `).join("") : "<p class='text-center'>å°šç„¡ç´€éŒ„</p>";
        document.getElementById('historyModal').style.display = 'flex';
    }

    function deleteRecord(id) {
        if(confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿé€²åº¦æœƒç¸®å›å»å–”ï¼")) {
            store.history = store.history.filter(h => h.id !== id);
            saveToDB(); updateUI(); closeModal();
        }
    }

    function closeModal() { document.getElementById('historyModal').style.display = 'none'; }

    function initSettingsPage() {
        document.getElementById('set-title').value = store.config.title;
        const area = document.getElementById('jarSetupArea');
        area.innerHTML = "";
        store.config.jars.forEach(jar => addJarUI(jar));
        if(!store.config.jars.length) addJarSetup();
    }

    function addJarUI(j = {unit: "$", name: "", goal: "", start: "2026-01", end: "2026-12"}) {
        const area = document.getElementById('jarSetupArea');
        const div = document.createElement('div');
        div.className = "setup-item";
        div.innerHTML = `
            <div class="grid-2">
                <div><span class="setup-label">å–®ä½</span><input type="text" class="j-unit" value="${j.unit}"></div>
                <div><span class="setup-label">éŒ¢ç­’åç¨±</span><input type="text" class="j-name" value="${j.name}"></div>
            </div>
            <div style="margin-top:10px;"><span class="setup-label">ç›®æ¨™ç¸½é‡‘é¡</span><input type="number" class="j-goal" value="${j.goal}"></div>
            <div class="grid-2">
                <div><span class="setup-label">é–‹å§‹æœˆä»½</span><input type="month" class="j-start" value="${j.start}"></div>
                <div><span class="setup-label">çµæŸæœˆä»½</span><input type="month" class="j-end" value="${j.end}"></div>
            </div>
            <button onclick="this.parentElement.remove()" style="width:100%; margin-top:15px; background:none; border:1px solid #ccc; border-radius:8px; font-size:11px; padding:5px; color:#999;">âœ• ç§»é™¤æ­¤éŒ¢ç­’</button>
        `;
        area.appendChild(div);
    }
    function addJarSetup() { addJarUI(); }

    function applySettings() {
        const newJars = [];
        document.querySelectorAll('.setup-item').forEach(item => {
            const name = item.querySelector('.j-name').value;
            if(name) newJars.push({
                unit: item.querySelector('.j-unit').value || "$",
                name: name,
                goal: Number(item.querySelector('.j-goal').value) || 0,
                start: item.querySelector('.j-start').value,
                end: item.querySelector('.j-end').value
            });
        });
        store.config.title = document.getElementById('set-title').value;
        store.config.jars = newJars;
        saveToDB(); location.reload();
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(store)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `cat_savings_backup.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            store = JSON.parse(ev.target.result);
            saveToDB(); location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    function saveToDB() { localStorage.setItem(DB_KEY, JSON.stringify(store)); }
    function showPage(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pId).classList.add('active');
        if(el) el.classList.add('active');
        if(pId === 'settings') initSettingsPage();
        window.scrollTo(0,0);
    }
    function cheerUp() {
        const quotes = ["å†å­˜ä¸€é»å°±èƒ½è²·å°é­šä¹¾äº†ï¼", "éŒ¢éŒ¢æ²’æœ‰ä¸è¦‹ï¼Œåªæ˜¯è®Šæˆäº†è²“è²“çš„å½¢ç‹€", "æ‘¸æ‘¸æˆ‘æœƒè®Šæœ‰éŒ¢å–”ï¼", "ä»Šå¤©ä¹Ÿå¾ˆåŠªåŠ›å‘¢ï¼"];
        const b = document.getElementById('cat-bubble');
        b.innerText = quotes[Math.floor(Math.random()*quotes.length)];
        b.style.display = 'block'; setTimeout(()=> b.style.display='none', 2000);
    }

    updateUI();
</script>
</body>
</html>
