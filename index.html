<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸ± è¬ç”¨å­˜éŒ¢æ‰‹å¸³</title>
    <style>
        :root { --cat-main: #FFB7B2; --cat-bg: #fffaf0; --cat-dark: #5D4037; --cat-gray: #D7CCC8; --cat-red: #ff7675; --cat-blue: #74b9ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background-color: var(--cat-bg); color: var(--cat-dark); margin: 0; padding: 0 0 100px 0; }
        .container { max-width: 450px; margin: 0 auto; padding: 20px; }
        .text-center { text-align: center; }
        .cat-card { background: #ffffff; border: 3px solid var(--cat-dark); box-shadow: 6px 6px 0px var(--cat-gray); border-radius: 20px; margin-bottom: 20px; padding: 16px; }
        
        /* é€²åº¦æ¢ */
        .prog-container { background: #EFEBE9; height: 26px; border-radius: 13px; border: 2px solid var(--cat-dark); overflow: hidden; margin: 8px 0; position: relative; }
        .prog-fill { height: 100%; transition: width 1s ease; background: var(--cat-main); border-right: 2px solid var(--cat-dark); }
        .prog-text { position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold; line-height: 22px; z-index: 5; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        .input-group { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px; }
        input, select, textarea { width: 100%; border: 2px solid var(--cat-gray); border-radius: 10px; padding: 10px; font-size: 15px; outline: none; }
        .btn-main { background: var(--cat-main); border: 2px solid var(--cat-dark); box-shadow: 0 4px 0px var(--cat-dark); font-weight: bold; color: white; border-radius: 12px; padding: 12px; width: 100%; cursor: pointer; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0px var(--cat-dark); }

        /* å°èˆª */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 3px solid var(--cat-dark); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .nav-item { border: none; background: none; font-size: 12px; font-weight: bold; color: var(--cat-gray); cursor: pointer; }
        .nav-item.active { color: var(--cat-main); }

        .page { display: none; }
        .page.active { display: block; }
        
        /* é ç®—èˆ‡è¨­å®šæ¨£å¼ */
        .setup-row { display: grid; grid-template-columns: 1fr 1fr 80px; gap: 5px; margin-bottom: 8px; }
        .history-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-home" class="page active">
        <h1 id="display-title" class="text-center" style="color: #FF748C;">ğŸ¾ æˆ‘çš„å­˜éŒ¢è¨ˆç•«</h1>
        <div class="cat-card" style="background: #2d3436; color: white; border-color: #2d3436;">
            <div style="display: flex; justify-content: space-between; font-size: 12px;"><span>è·é›¢ç›®æ¨™å‰©é¤˜</span><span id="mLeft" style="color: #fdcb6e; font-weight: bold;">-- å€‹æœˆ</span></div>
            <div class="prog-container" style="background: #636e72; border-color: white; height: 10px;"><div id="timeBar" class="prog-fill" style="background: #fdcb6e; border:none;"></div></div>
        </div>
        <div id="jarList"></div>
        <div class="cat-card">
            <h3 class="text-center" style="margin:0 0 10px 0">ğŸ¼ é¤µé£Ÿç´€éŒ„</h3>
            <div id="inputGrid" class="setup-row" style="grid-template-columns: 1fr 1fr;"></div>
            <button onclick="saveRecord()" class="btn-main" style="margin-top:10px">ç¢ºèªå­˜å…¥</button>
        </div>
    </div>

    <div id="page-budget" class="page">
        <h2 class="text-center">ğŸ“ é ç®—è¦åŠƒè¡¨</h2>
        <div class="cat-card">
            <textarea id="budget-content" style="height: 300px; font-family: monospace; font-size: 14px; line-height: 1.6;" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„é ç®—è¦åŠƒ..."></textarea>
            <button onclick="saveBudget()" class="btn-main" style="margin-top:10px; background:var(--cat-blue)">å„²å­˜è¦åŠƒå…§å®¹</button>
        </div>
    </div>

    <div id="page-settings" class="page">
        <h2 class="text-center">âš™ï¸ è¨ˆç•«æ ¸å¿ƒè¨­å®š</h2>
        <div class="cat-card">
            <div class="input-group"><label>è¨ˆç•«æ¨™é¡Œ</label><input type="text" id="set-title"></div>
            <div class="input-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="month" id="set-start"></div>
            <div class="input-group"><label>ç›®æ¨™æ—¥æœŸ</label><input type="month" id="set-end"></div>
            <hr>
            <label>å­˜éŒ¢ç­’é…ç½® (åç¨± / ç›®æ¨™é‡‘é¡ / æ¯æœˆæ‡‰å­˜)</label>
            <div id="jarSetupArea"></div>
            <button onclick="addJarSetup()" class="btn-small" style="margin-bottom:10px">+ å¢åŠ å­˜éŒ¢ç­’</button>
            <button onclick="applySettings()" class="btn-main">å¥—ç”¨ä¸¦é‡æ–°é–‹å§‹è¨ˆç•«</button>
        </div>
        <div class="cat-card" style="background:#eee">
            <h3>ğŸ’¾ æ•¸æ“šç®¡ç†</h3>
            <button onclick="exportData()" class="btn-small">åŒ¯å‡ºå‚™ä»½ (.json)</button>
            <button onclick="document.getElementById('fileInput').click()" class="btn-small">åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
            <button onclick="fullReset()" style="color:red; background:none; border:none; font-size:10px; margin-top:10px">âš ï¸ å¾¹åº•æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <div id="page-history" class="page">
        <h2 class="text-center">ğŸ“œ å­˜æ¬¾ç´€éŒ„</h2>
        <div class="cat-card" id="historyList"></div>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="showPage('home', this)">ğŸ  ä¸»é </button>
    <button class="nav-item" onclick="showPage('budget', this)">ğŸ“ é ç®—</button>
    <button class="nav-item" onclick="showPage('history', this)">ğŸ“œ ç´€éŒ„</button>
    <button class="nav-item" onclick="showPage('settings', this)">âš™ï¸ è¨­å®š</button>
</nav>

<script>
    const DB_KEY = 'cat_universal_v1';
    
    // é è¨­åˆå§‹è³‡æ–™
    let defaultData = {
        config: {
            title: "2035 ç’°å³¶è¨ˆç•«",
            start: "2026-03",
            end: "2035-10",
            jars: [
                { name: "å¹´åº¦å°å¹£", goal: 10800, monthly: 900, unit: "$" },
                { name: "å¹´åº¦æ—¥å¹£", goal: 50400, monthly: 4200, unit: "Â¥" }
            ]
        },
        balances: {},
        history: [],
        budgetText: "åœ¨æ­¤è¼¸å…¥ä½ çš„é ç®—è¦åŠƒ..."
    };

    let store = JSON.parse(localStorage.getItem(DB_KEY)) || defaultData;

    function showPage(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pId).classList.add('active');
        if(el) el.classList.add('active');
        if(pId === 'history') renderHistory();
        if(pId === 'settings') initSettingsPage();
        if(pId === 'budget') document.getElementById('budget-content').value = store.budgetText;
    }

    function initSettingsPage() {
        document.getElementById('set-title').value = store.config.title;
        document.getElementById('set-start').value = store.config.start;
        document.getElementById('set-end').value = store.config.end;
        const area = document.getElementById('jarSetupArea');
        area.innerHTML = "";
        store.config.jars.forEach((jar, index) => {
            area.innerHTML += `
                <div class="setup-row" id="setup-row-${index}">
                    <input type="text" value="${jar.name}" placeholder="åç¨±">
                    <input type="number" value="${jar.goal}" placeholder="ç¸½ç›®æ¨™">
                    <button onclick="removeJarSetup(${index})" style="background:none; border:none; color:red">âœ•</button>
                </div>`;
        });
    }

    function addJarSetup() {
        const area = document.getElementById('jarSetupArea');
        const idx = area.children.length;
        const div = document.createElement('div');
        div.className = "setup-row";
        div.id = `setup-row-${idx}`;
        div.innerHTML = `<input type="text" placeholder="åç¨±"> <input type="number" placeholder="ç¸½ç›®æ¨™"> <button onclick="this.parentElement.remove()" style="background:none; border:none; color:red">âœ•</button>`;
        area.appendChild(div);
    }

    function applySettings() {
        if(!confirm("å¥—ç”¨æ–°è¨­å®šå°‡æœƒä¿ç•™ç´€éŒ„ï¼Œä½†æœƒé‡æ–°è¨ˆç®—é€²åº¦æ¢ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        const newJars = [];
        document.querySelectorAll('#jarSetupArea .setup-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            if(inputs[0].value) {
                newJars.push({
                    name: inputs[0].value,
                    goal: Number(inputs[1].value) || 0,
                    unit: inputs[0].value.includes("æ—¥å¹£") ? "Â¥" : "$"
                });
            }
        });
        store.config.title = document.getElementById('set-title').value;
        store.config.start = document.getElementById('set-start').value;
        store.config.end = document.getElementById('set-end').value;
        store.config.jars = newJars;
        saveToDB();
        location.reload();
    }

    function updateUI() {
        document.getElementById('display-title').innerText = store.config.title;
        const start = new Date(store.config.start);
        const end = new Date(store.config.end);
        const now = new Date();

        let mLeft = (end.getFullYear() - now.getFullYear()) * 12 + (end.getMonth() - now.getMonth());
        document.getElementById('mLeft').innerText = (mLeft > 0 ? mLeft : 0) + " å€‹æœˆ";
        let timePct = Math.min(Math.max(((now - start) / (end - start)) * 100, 0), 100);
        document.getElementById('timeBar').style.width = timePct + '%';

        const list = document.getElementById('jarList');
        const grid = document.getElementById('inputGrid');
        list.innerHTML = ""; grid.innerHTML = "";

        store.config.jars.forEach(jar => {
            const cur = store.balances[jar.name] || 0;
            const pct = Math.min(Math.round((cur / jar.goal) * 100), 100);
            list.innerHTML += `
                <div class="cat-card">
                    <div style="display:flex;justify-content:space-between;font-size:13px;font-weight:bold;">
                        <span>${jar.name}</span><span>${jar.unit}${cur.toLocaleString()} / ${jar.goal.toLocaleString()}</span>
                    </div>
                    <div class="prog-container">
                        <div class="prog-text">${pct}%</div>
                        <div class="prog-fill" style="width:${pct}%"></div>
                    </div>
                </div>`;
            grid.innerHTML += `<div><small>${jar.name}</small><input type="number" class="record-input" data-name="${jar.name}"></div>`;
        });
    }

    function saveRecord() {
        let entry = { id: Date.now(), time: new Date().toLocaleString(), vals: {} };
        let hasValue = false;
        document.querySelectorAll('.record-input').forEach(input => {
            const val = Number(input.value) || 0;
            if(val !== 0) {
                const name = input.dataset.name;
                store.balances[name] = (store.balances[name] || 0) + val;
                entry.vals[name] = val;
                hasValue = true;
            }
            input.value = "";
        });
        if(hasValue) {
            store.history.unshift(entry);
            saveToDB();
            updateUI();
            alert("å­˜å…¥æˆåŠŸï¼");
        }
    }

    function renderHistory() {
        const hList = document.getElementById('historyList');
        if (store.history.length === 0) { hList.innerHTML = '<p class="text-center">å°šç„¡ç´€éŒ„</p>'; return; }
        hList.innerHTML = store.history.map(item => `
            <div class="history-row">
                <div>
                    <div style="color:#999;font-size:10px;">${item.time}</div>
                    <div>${Object.entries(item.vals).map(([k,v]) => `${k}: ${v}`).join(", ")}</div>
                </div>
                <button onclick="deleteItem(${item.id})" style="background:none; border:none; color:red">ğŸ—‘ï¸</button>
            </div>`).join("");
    }

    function deleteItem(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const idx = store.history.findIndex(i => i.id === id);
        if(idx > -1) {
            const item = store.history[idx];
            Object.entries(item.vals).forEach(([k, v]) => store.balances[k] -= v);
            store.history.splice(idx, 1);
            saveToDB(); updateUI(); renderHistory();
        }
    }

    function saveBudget() {
        store.budgetText = document.getElementById('budget-content').value;
        saveToDB();
        alert("é ç®—è¦åŠƒå·²å„²å­˜ï¼");
    }

    function saveToDB() { localStorage.setItem(DB_KEY, JSON.stringify(store)); }
    function exportData() {
        const blob = new Blob([JSON.stringify(store)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `backup_${store.config.title}.json`; a.click();
    }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            store = JSON.parse(event.target.result);
            saveToDB(); location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }
    function fullReset() { if(confirm("é€™å°‡æŠ¹é™¤æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ")) { localStorage.removeItem(DB_KEY); location.reload(); } }

    updateUI();
</script>
</body>
</html>
