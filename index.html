<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± å¤¢æƒ³è²“å’ªå­˜éŒ¢æ‰‹å¸³</title>
    <style>
        :root { --cat-main: #FFB7B2; --cat-bg: #fffaf0; --cat-dark: #5D4037; --cat-gray: #D7CCC8; --cat-red: #ff7675; --cat-green: #55efc4; --cat-blue: #74b9ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background-color: var(--cat-bg); color: var(--cat-dark); margin: 0; padding: 0 0 120px 0; }
        .container { max-width: 450px; margin: 0 auto; padding: 20px; }
        .text-center { text-align: center; }
        
        /* è²“å’ªäº’å‹•å€ */
        .cat-interaction { text-align: center; margin-bottom: 20px; position: relative; cursor: pointer; }
        .cat-emoji { font-size: 60px; display: block; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cat-emoji:active { transform: scale(1.3); }
        .bubble { position: absolute; background: white; border: 2px solid var(--cat-dark); border-radius: 15px; padding: 8px 12px; font-size: 14px; font-weight: bold; top: -10px; right: 20%; display: none; z-index: 10; }
        .bubble::after { content: ''; position: absolute; bottom: -10px; left: 20px; border-width: 10px 10px 0; border-style: solid; border-color: white transparent; }
        .bubble::before { content: ''; position: absolute; bottom: -13px; left: 19px; border-width: 11px 11px 0; border-style: solid; border-color: var(--cat-dark) transparent; }

        .cat-card { background: #ffffff; border: 3px solid var(--cat-dark); box-shadow: 6px 6px 0px var(--cat-gray); border-radius: 20px; margin-bottom: 20px; padding: 16px; }
        .status-alert { padding: 10px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; font-size: 14px; border: 2px solid var(--cat-dark); text-align: center; }
        .status-unpaid { background: #ffeaa7; color: #d63031; border-color: #d63031; }
        .status-paid { background: #b2f2bb; color: #2b8a3e; border-color: #2b8a3e; }
        
        .prog-container { background: #EFEBE9; height: 26px; border-radius: 13px; border: 2px solid var(--cat-dark); overflow: hidden; margin: 8px 0; position: relative; }
        .prog-fill { height: 100%; transition: width 1s ease; background: var(--cat-main); border-right: 2px solid var(--cat-dark); }
        .prog-text { position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold; line-height: 22px; z-index: 5; }

        .nav-bar { position: fixed; bottom: 25px; left: 15px; right: 15px; background: rgba(255, 255, 255, 0.95); border: 3px solid var(--cat-dark); box-shadow: 0 10px 0px var(--cat-gray); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; border-radius: 30px; }
        .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 60px; }
        .nav-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; border-radius: 50%; margin-bottom: 4px; background: #f5f5f5; transition: all 0.2s; }
        .nav-item.active .nav-icon { background: var(--cat-main); border: 2px solid var(--cat-dark); box-shadow: 0 3px 0 var(--cat-dark); }
        
        .mode-switch { display: flex; background: #eee; border-radius: 12px; padding: 4px; margin-bottom: 15px; border: 2px solid var(--cat-dark); }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; font-weight: bold; cursor: pointer; background: none; color: #999; }
        .mode-btn.active { background: white; color: var(--cat-dark); }
        .page { display: none; }
        .page.active { display: block; }
        input { width: 100%; border: 2px solid var(--cat-gray); border-radius: 10px; padding: 10px; font-size: 15px; outline: none; }
        .btn-main { background: var(--cat-main); border: 2px solid var(--cat-dark); box-shadow: 0 4px 0px var(--cat-dark); font-weight: bold; color: white; border-radius: 12px; padding: 12px; width: 100%; cursor: pointer; margin-top: 10px; }
        .setup-row { display: grid; grid-template-columns: 1fr 1.5fr 0.8fr 40px; gap: 5px; margin-bottom: 8px; align-items: center; }
        .history-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-home" class="page active">
        <div class="cat-interaction" onclick="cheerUp()">
            <div id="cat-bubble" class="bubble">å–µå—šï¼Ÿ</div>
            <span id="cat-avatar" class="cat-emoji">ğŸ’¤</span>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">é»é»è²“å’ªå¯ä»¥äº’å‹•å–”ï¼</div>
        </div>

        <h1 id="display-title" class="text-center" style="color: #FF748C; margin-top: 0;">ğŸ¾ å¤¢æƒ³è¨ˆç•«</h1>
        <div id="monthly-status" class="status-alert"></div>
        
        <div class="cat-card" style="background: #2d3436; color: white; border-color: #2d3436;">
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span>å‰©é¤˜é”æ¨™æ™‚é–“</span>
                <span id="mLeft" style="color: #fdcb6e; font-weight: bold;">-- å€‹æœˆ</span>
            </div>
            <div class="prog-container" style="background: #636e72; border-color: white; height: 10px;">
                <div id="timeBar" class="prog-fill" style="background: #fdcb6e; border:none;"></div>
            </div>
        </div>

        <div id="jarList"></div>

        <div class="cat-card" style="background: #fff5f5;">
            <h3 class="text-center" style="margin:0 0 10px 0">ğŸ¼ å¸³å‹™èª¿æ•´</h3>
            <div class="mode-switch">
                <button id="btn-save-mode" class="mode-btn active" onclick="setMode('save')">å­˜æ¬¾ ğŸŸ</button>
                <button id="btn-spend-mode" class="mode-btn" onclick="setMode('spend')">æ”¯å‡º ğŸ’¸</button>
            </div>
            <div id="inputGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
            <button id="submit-btn" onclick="saveRecord()" class="btn-main">ç¢ºèªå­˜å…¥ ğŸŸ</button>
        </div>
    </div>

    <div id="page-budget" class="page"><h2 class="text-center">ğŸ“ é ç®—ç­†è¨˜</h2><div class="cat-card"><textarea id="budget-content" style="height: 350px; width:100%; border:2px solid var(--cat-gray); border-radius:10px; padding:10px;" placeholder="å¯«ä¸‹å…·é«”çš„æ¡è³¼æ¸…å–®..."></textarea><button onclick="saveBudget()" class="btn-main" style="background:var(--cat-blue)">å„²å­˜ç­†è¨˜</button></div></div>
    
    <div id="page-history" class="page"><h2 class="text-center">ğŸ“œ æ­·å²ç´€éŒ„</h2><div class="cat-card" id="historyList"></div></div>
    
    <div id="page-settings" class="page">
        <h2 class="text-center">âš™ï¸ è¨­å®š</h2>
        <div class="cat-card">
            <label>è¨ˆç•«æ¨™é¡Œ</label><input type="text" id="set-title"><br><br>
            <label>é–‹å§‹ / çµæŸæœˆä»½</label>
            <div style="display: flex; gap: 5px;"><input type="month" id="set-start"><input type="month" id="set-end"></div>
            <p style="font-size: 11px; color: #888;">* åŒ…å«é–‹å§‹èˆ‡çµæŸç•¶æœˆï¼Œç¸½æœˆæ•¸æœƒæ­£ç¢ºè¨ˆç®—ã€‚</p>
            <label>å­˜éŒ¢ç­’ (å–®ä½ / åç¨± / ç›®æ¨™)</label>
            <div id="jarSetupArea"></div>
            <button onclick="addJarSetup()" class="btn-main" style="background:#fff; color:var(--cat-dark); padding:5px; font-size:12px">+ å¢åŠ å­˜éŒ¢ç­’</button>
            <button onclick="applySettings()" class="btn-main" style="margin-top:20px; background:#55efc4">å¥—ç”¨è¨­å®š</button>
        </div>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="showPage('home', this)"><div class="nav-icon">ğŸ </div></button>
    <button class="nav-item" onclick="showPage('budget', this)"><div class="nav-icon">ğŸ“</div></button>
    <button class="nav-item" onclick="showPage('history', this)"><div class="nav-icon">ğŸ“œ</div></button>
    <button class="nav-item" onclick="showPage('settings', this)"><div class="nav-icon">âš™ï¸</div></button>
</nav>

<script>
    const DB_KEY = 'cat_universal_v6'; 
    let currentMode = 'save';
    let defaultData = {
        config: { title: "æˆ‘çš„å­˜éŒ¢è¨ˆç•«", start: "2026-01", end: "2026-12", jars: [{ name: "å­˜æ¬¾é‡‘", goal: 10000, unit: "$" }] },
        balances: {}, history: [], budgetText: ""
    };
    let store = JSON.parse(localStorage.getItem(DB_KEY)) || defaultData;

    const catQuotes = ["å–µï¼ä»Šå¤©ä¹ŸåŠ æ²¹ï¼", "æ‘¸æ‘¸æˆ‘æœƒè®Šæœ‰éŒ¢å–”ï¼", "æœ‰å­˜éŒ¢ï¼Œçµ¦ä½ ä¸€å€‹è®šï¼", "å°é­šä¹¾åœ¨ç­‰ä½ äº†ï¼", "åˆ¥äº‚èŠ±éŒ¢å–”å–µï½"];

    function cheerUp() {
        const bubble = document.getElementById('cat-bubble');
        bubble.innerText = catQuotes[Math.floor(Math.random() * catQuotes.length)];
        bubble.style.display = 'block';
        setTimeout(() => { bubble.style.display = 'none'; }, 2500);
    }

    function setMode(mode) {
        currentMode = mode;
        const btnSave = document.getElementById('btn-save-mode');
        const btnSpend = document.getElementById('btn-spend-mode');
        const submitBtn = document.getElementById('submit-btn');
        if(mode === 'save') {
            btnSave.classList.add('active'); btnSpend.classList.remove('active');
            submitBtn.innerText = "ç¢ºèªå­˜å…¥ ğŸŸ"; submitBtn.style.background = "var(--cat-main)";
        } else {
            btnSpend.classList.add('active'); btnSave.classList.remove('active');
            submitBtn.innerText = "åŸ·è¡Œæ”¯å‡ºæ‰£é™¤ ğŸ’¸"; submitBtn.style.background = "var(--cat-red)";
        }
    }

    function showPage(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pId).classList.add('active');
        if(el) el.classList.add('active');
        if(pId === 'history') renderHistory();
        if(pId === 'settings') initSettingsPage();
        if(pId === 'budget') document.getElementById('budget-content').value = store.budgetText;
        window.scrollTo(0, 0);
    }

    function initSettingsPage() {
        document.getElementById('set-title').value = store.config.title;
        document.getElementById('set-start').value = store.config.start;
        document.getElementById('set-end').value = store.config.end;
        const area = document.getElementById('jarSetupArea');
        area.innerHTML = "";
        store.config.jars.forEach(jar => {
            const div = document.createElement('div');
            div.className = "setup-row";
            div.innerHTML = `<input type="text" value="${jar.unit || '$'}" placeholder="å–®"> <input type="text" value="${jar.name}"> <input type="number" value="${jar.goal}"> <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none;">âœ•</button>`;
            area.appendChild(div);
        });
    }

    function addJarSetup() {
        const area = document.getElementById('jarSetupArea');
        const div = document.createElement('div');
        div.className = "setup-row";
        div.innerHTML = `<input type="text" value="$" placeholder="å–®"> <input type="text" placeholder="åç¨±"> <input type="number" placeholder="ç›®æ¨™"> <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none;">âœ•</button>`;
        area.appendChild(div);
    }

    function applySettings() {
        const newJars = [];
        document.querySelectorAll('#jarSetupArea .setup-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            if(inputs[1].value) newJars.push({ unit: inputs[0].value, name: inputs[1].value, goal: Number(inputs[2].value) || 0 });
        });
        store.config.title = document.getElementById('set-title').value;
        store.config.start = document.getElementById('set-start').value;
        store.config.end = document.getElementById('set-end').value;
        store.config.jars = newJars;
        saveToDB(); location.reload();
    }

    function updateUI() {
        document.getElementById('display-title').innerText = "ğŸ¾ " + store.config.title;
        const now = new Date();
        const start = new Date(store.config.start);
        const end = new Date(store.config.end);

        // æ­£ç¢ºçš„æœˆä»½ç¸½æ•¸è¨ˆç®—ï¼š(å¹´å·®*12 + æœˆå·®) + 1 (åŒ…å«é¦–å°¾)
        let totalMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
        totalMonths = Math.max(totalMonths, 1);
        
        // å·²éæœˆæ•¸ (åŒ…å«ç•¶æœˆ)
        let passedMonths = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
        passedMonths = Math.max(0, Math.min(passedMonths, totalMonths - 1));
        
        let mLeft = totalMonths - (passedMonths + 1);
        document.getElementById('mLeft').innerText = Math.max(0, mLeft) + " å€‹æœˆ";
        let timePct = Math.min(Math.max(((passedMonths + 1) / totalMonths) * 100, 0), 100);
        document.getElementById('timeBar').style.width = timePct + '%';

        const list = document.getElementById('jarList');
        const grid = document.getElementById('inputGrid');
        list.innerHTML = ""; grid.innerHTML = "";
        
        let totalProgressSum = 0;

        store.config.jars.forEach(jar => {
            const cur = store.balances[jar.name] || 0;
            const pct = Math.min(Math.round((cur / jar.goal) * 100), 100);
            totalProgressSum += pct;
            const unit = jar.unit || "$";
            const targetNow = Math.round((jar.goal / totalMonths) * (passedMonths + 1));
            const gap = targetNow - cur;

            list.innerHTML += `<div class="cat-card"><div style="display:flex;justify-content:space-between;font-size:13px;font-weight:bold;"><span>${jar.name}</span><span>${unit}${cur.toLocaleString()} / ${jar.goal.toLocaleString()}</span></div><div class="prog-container"><div class="prog-text">${pct}%</div><div class="prog-fill" style="width:${pct}%"></div></div><div style="font-size:10px; color:#666; display:flex; justify-content:space-between; margin-top:4px;"><span>ğŸ“ æ‡‰å­˜: ${unit}${targetNow.toLocaleString()}</span><span style="color:${gap > 0 ? 'var(--cat-red)' : 'var(--cat-green)'};">${gap > 0 ? 'å·® ' + unit + gap.toLocaleString() : 'é ˜å…ˆä¸­ âœ¨'}</span></div></div>`;
            const suggest = Math.ceil((jar.goal - cur) / Math.max(mLeft + 1, 1));
            grid.innerHTML += `<div><small style="font-size:10px; color:#888;">å»ºè­°å­˜: ${unit}${suggest.toLocaleString()}</small><input type="number" class="record-input" data-name="${jar.name}" placeholder="${jar.name}"></div>`;
        });

        // è²“å’ªç‹€æ…‹æ›´æ–°
        const avgPct = totalProgressSum / (store.config.jars.length || 1);
        const avatar = document.getElementById('cat-avatar');
        if(avgPct === 0) avatar.innerText = "ğŸ’¤";
        else if(avgPct < 40) avatar.innerText = "ğŸ±";
        else if(avgPct < 80) avatar.innerText = "ğŸ˜º";
        else if(avgPct < 100) avatar.innerText = "ğŸ˜»";
        else avatar.innerText = "ğŸŠ";

        // æœ¬æœˆå­˜éŒ¢ç‹€æ…‹
        const currentMonthStr = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        const hasDeposited = store.history.some(h => h.time.startsWith(currentMonthStr) && h.type === 'save');
        const alertEl = document.getElementById('monthly-status');
        alertEl.className = "status-alert " + (hasDeposited ? "status-paid" : "status-unpaid");
        alertEl.innerHTML = hasDeposited ? "âœ¨ å–µï¼æœ¬æœˆå·²ç¶“é¤µé£Ÿå¤¢æƒ³äº†ï¼" : "âš ï¸ å–µï¼é€™å€‹æœˆé‚„æ²’å­˜éŒ¢å”·ï¼";

        saveToDB();
    }

    function saveRecord() {
        let entry = { id: Date.now(), time: new Date().toISOString(), vals: {}, type: currentMode };
        let hasValue = false;
        document.querySelectorAll('.record-input').forEach(input => {
            let val = Number(input.value) || 0;
            if(val !== 0) {
                const name = input.dataset.name;
                if(currentMode === 'spend') val = -Math.abs(val);
                store.balances[name] = (store.balances[name] || 0) + val;
                entry.vals[name] = val; hasValue = true;
            }
            input.value = "";
        });
        if(hasValue) { store.history.unshift(entry); saveToDB(); updateUI(); alert("å–µï¼ç´€éŒ„æˆåŠŸï¼"); }
    }

    function renderHistory() {
        const hList = document.getElementById('historyList');
        if (store.history.length === 0) { hList.innerHTML = '<p class="text-center">é‚„æ²’æœ‰ç´€éŒ„å–”</p>'; return; }
        hList.innerHTML = store.history.map(item => {
            const d = new Date(item.time);
            return `<div class="history-row"><div><div style="font-size:10px; color:#999;"><span style="background:${item.type==='spend'?'var(--cat-red)':'var(--cat-green)'}; color:white; padding:1px 4px; border-radius:3px; margin-right:4px;">${item.type==='spend'?'æ”¯å‡º':'å­˜æ¬¾'}</span>${d.toLocaleDateString()}</div><div style="font-weight:bold;">${Object.entries(item.vals).map(([k,v]) => `${k}:${v}`).join(", ")}</div></div><button onclick="deleteItem(${item.id})" style="background:none; border:none; color:red; font-size:16px;">ğŸ—‘ï¸</button></div>`}).join("");
    }

    function deleteItem(id) {
        if(!confirm("è¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        const idx = store.history.findIndex(i => i.id === id);
        if(idx > -1) {
            const item = store.history[idx];
            Object.entries(item.vals).forEach(([k, v]) => store.balances[k] -= v);
            store.history.splice(idx, 1); saveToDB(); updateUI(); renderHistory();
        }
    }

    function saveBudget() { store.budgetText = document.getElementById('budget-content').value; saveToDB(); alert("ç­†è¨˜å·²å„²å­˜ï¼"); }
    function saveToDB() { localStorage.setItem(DB_KEY, JSON.stringify(store)); }
    
    updateUI();
</script>
</body>
</html>
