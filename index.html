<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± å¤¢æƒ³è²“å’ªå­˜éŒ¢æ‰‹å¸³ V2.2</title>
    <style>
        :root { --cat-main: #FFB7B2; --cat-bg: #fffaf0; --cat-dark: #5D4037; --cat-gray: #D7CCC8; --cat-red: #ff7675; --cat-green: #55efc4; --cat-blue: #74b9ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background-color: var(--cat-bg); color: var(--cat-dark); margin: 0; padding: 0 0 120px 0; }
        .container { max-width: 450px; margin: 0 auto; padding: 20px; }
        .text-center { text-align: center; }
        
        /* è²“å’ªäº’å‹• */
        .cat-interaction { text-align: center; margin-bottom: 20px; position: relative; cursor: pointer; height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .cat-emoji { font-size: 60px; display: block; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2; }
        .cat-emoji:active { transform: scale(1.3); }
        .bubble { position: absolute; background: white; border: 2px solid var(--cat-dark); border-radius: 15px; padding: 8px 12px; font-size: 14px; font-weight: bold; top: 0px; left: 55%; display: none; z-index: 10; width: 150px; box-shadow: 4px 4px 0 var(--cat-gray); }
        
        .cat-card { background: #ffffff; border: 3px solid var(--cat-dark); box-shadow: 6px 6px 0px var(--cat-gray); border-radius: 20px; margin-bottom: 20px; padding: 16px; }
        .status-alert { padding: 10px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; font-size: 14px; border: 2px solid var(--cat-dark); text-align: center; }
        .status-unpaid { background: #ffeaa7; color: #d63031; }
        .status-paid { background: #b2f2bb; color: #2b8a3e; }
        
        .prog-container { background: #EFEBE9; height: 26px; border-radius: 13px; border: 2px solid var(--cat-dark); overflow: hidden; margin: 8px 0; position: relative; }
        .prog-fill { height: 100%; transition: width 1s ease; background: var(--cat-main); border-right: 2px solid var(--cat-dark); }
        .prog-text { position: absolute; width: 100%; text-align: center; font-size: 12px; font-weight: bold; line-height: 22px; z-index: 5; }

        .nav-bar { position: fixed; bottom: 25px; left: 15px; right: 15px; background: rgba(255, 255, 255, 0.95); border: 3px solid var(--cat-dark); box-shadow: 0 8px 0px var(--cat-gray); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; border-radius: 30px; }
        .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; width: 60px; }
        .nav-icon { font-size: 24px; padding: 5px; }
        .nav-item.active .nav-icon { background: var(--cat-main); border-radius: 15px; border: 2px solid var(--cat-dark); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        /* è¨­å®šé æ ¼ä½å„ªåŒ– */
        .setup-item { background: #fdfdfd; padding: 15px; border: 2px solid var(--cat-dark); border-radius: 15px; margin-bottom: 15px; box-shadow: 4px 4px 0 #eee; }
        .setup-row-top { display: grid; grid-template-columns: 80px 1fr 40px; gap: 10px; margin-bottom: 12px; }
        .setup-row-bottom { width: 100%; }
        .setup-label { font-size: 12px; font-weight: bold; color: var(--cat-dark); margin-bottom: 4px; display: block; }
        
        input { width: 100%; border: 2px solid var(--cat-dark); border-radius: 10px; padding: 12px; font-size: 16px; background: white; outline: none; }
        input:focus { border-color: var(--cat-main); background: #fffcfc; }
        
        .btn-main { background: var(--cat-main); border: 2px solid var(--cat-dark); box-shadow: 0 4px 0px var(--cat-dark); font-weight: bold; color: white; border-radius: 12px; padding: 14px; width: 100%; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0px var(--cat-dark); }
        .btn-delete { color: #ff7675; background: #fff; border: 2px solid #ff7675; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 45px; margin-top: 20px; }
        
        .backup-section { margin-top: 30px; padding-top: 20px; border-top: 2px dashed var(--cat-gray); }
        .btn-outline { background: white; color: var(--cat-dark); border: 2px solid var(--cat-dark); font-size: 14px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-home" class="page active">
        <div class="cat-interaction" onclick="cheerUp()">
            <div id="cat-bubble" class="bubble">å–µå—šï¼Ÿ</div>
            <span id="cat-avatar" class="cat-emoji">ğŸ’¤</span>
        </div>
        
        <h1 id="display-title" class="text-center" style="color: #FF748C; margin: 0 0 15px 0; font-size: 24px;">è¼‰å…¥ä¸­...</h1>
        <div id="monthly-status" class="status-alert"></div>
        
        <div class="cat-card" style="background: #2d3436; color: white;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom:5px;">
                <span>â³ è·é›¢çµæŸé‚„æœ‰</span>
                <span id="mLeft" style="color: #fdcb6e; font-weight: bold;">--</span>
            </div>
            <div class="prog-container" style="background: #636e72; border-color: white; height: 10px;">
                <div id="timeBar" class="prog-fill" style="background: #fdcb6e; border:none;"></div>
            </div>
        </div>

        <div id="jarList"></div>

        <div class="cat-card" style="background: #fff5f5;">
            <h3 class="text-center" style="margin:0 0 15px 0">ğŸŸ å¿«é€Ÿé¤µé£Ÿ (å­˜éŒ¢)</h3>
            <div id="inputGrid" style="display: grid; grid-template-columns: 1fr; gap: 15px;"></div>
            <button id="submit-btn" onclick="saveRecord()" class="btn-main">ç¢ºèªå­˜å…¥ ğŸŸ</button>
        </div>
    </div>

    <div id="page-settings" class="page">
        <h2 class="text-center">âš™ï¸ è¨ˆç•«æ ¸å¿ƒè¨­å®š</h2>
        <div class="cat-card">
            <label class="setup-label">âœï¸ è¨ˆç•«æ¨™é¡Œ</label>
            <input type="text" id="set-title" style="margin-bottom:20px" placeholder="ä¾‹å¦‚ï¼š2026 åœ“å¤¢è¨ˆç•«">
            
            <label class="setup-label">ğŸ“… è¨ˆç•«æœŸé–“ (å¾...åˆ°...)</label>
            <div style="display: flex; gap: 10px; margin-bottom:25px">
                <input type="month" id="set-start">
                <input type="month" id="set-end">
            </div>

            <label class="setup-label">ğŸ’° å­˜éŒ¢ç­’è©³ç´°é…ç½®</label>
            <div id="jarSetupArea"></div>
            
            <button onclick="addJarSetup()" class="btn-main" style="background:#fff; color:var(--cat-dark); border-style:dashed; margin-bottom: 20px;">+ å¢åŠ å­˜éŒ¢ç­’</button>
            
            <button onclick="applySettings()" class="btn-main" style="background:var(--cat-green); font-size:18px; box-shadow: 0 4px 0 #2b8a3e;">å„²å­˜ä¸¦å¥—ç”¨è¨­å®š âœ¨</button>

            <div class="backup-section">
                <h4 style="margin: 0 0 15px 0;">ğŸ’¾ æ•¸æ“šä¿éšªç®±</h4>
                <button onclick="exportData()" class="btn-main btn-outline">ğŸ“¤ åŒ¯å‡ºè³‡æ–™å‚™ä»½ (.json)</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-main btn-outline">ğŸ“¥ åŒ¯å…¥è³‡æ–™é‚„åŸ</button>
                <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
                <p style="font-size: 11px; color: #999; text-align: center;">å»ºè­°æ¯æœˆå‚™ä»½ä¸€æ¬¡ï¼Œç¢ºä¿è³‡æ–™ä¸éºå¤±ã€‚</p>
            </div>
        </div>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="showPage('home', this)"><span class="nav-icon">ğŸ </span></button>
    <button class="nav-item" onclick="showPage('settings', this)"><span class="nav-icon">âš™ï¸</span></button>
</nav>

<script>
    const DB_KEY = 'cat_dream_v8';
    let store = JSON.parse(localStorage.getItem(DB_KEY)) || {
        config: { title: "æˆ‘çš„å­˜éŒ¢è¨ˆç•«", start: "2026-01", end: "2026-12", jars: [{ unit: "$", name: "æ—…éŠåŸºé‡‘", goal: 50000 }] },
        balances: {}, history: []
    };

    // åˆå§‹è¼‰å…¥
    function initSettingsPage() {
        document.getElementById('set-title').value = store.config.title;
        document.getElementById('set-start').value = store.config.start;
        document.getElementById('set-end').value = store.config.end;
        const area = document.getElementById('jarSetupArea');
        area.innerHTML = "";
        store.config.jars.forEach(jar => addJarUI(jar.unit, jar.name, jar.goal));
    }

    function addJarUI(unit = "$", name = "", goal = "") {
        const area = document.getElementById('jarSetupArea');
        const div = document.createElement('div');
        div.className = "setup-item";
        div.innerHTML = `
            <div class="setup-row-top">
                <div>
                    <span class="setup-label">å–®ä½</span>
                    <input type="text" value="${unit}" placeholder="$" style="text-align:center">
                </div>
                <div>
                    <span class="setup-label">å­˜éŒ¢ç­’åç¨±</span>
                    <input type="text" value="${name}" placeholder="ä¾‹å¦‚ï¼šè²·ç­†é›»">
                </div>
                <button class="btn-delete" onclick="this.parentElement.parentElement.remove()">âœ•</button>
            </div>
            <div class="setup-row-bottom">
                <span class="setup-label">ç›®æ¨™ç¸½é‡‘é¡ (å¤§æ ¼å­å¥½è¼¸å…¥)</span>
                <input type="number" value="${goal}" placeholder="è«‹è¼¸å…¥ç›®æ¨™é‡‘é¡">
            </div>
        `;
        area.appendChild(div);
    }

    function addJarSetup() { addJarUI(); }

    function applySettings() {
        const newJars = [];
        document.querySelectorAll('.setup-item').forEach(item => {
            const inputs = item.querySelectorAll('input');
            if(inputs[1].value) {
                newJars.push({ 
                    unit: inputs[0].value || "$", 
                    name: inputs[1].value, 
                    goal: Number(inputs[2].value) || 0 
                });
            }
        });
        store.config.title = document.getElementById('set-title').value;
        store.config.start = document.getElementById('set-start').value;
        store.config.end = document.getElementById('set-end').value;
        store.config.jars = newJars;
        saveToDB();
        location.reload();
    }

    function updateUI() {
        document.getElementById('display-title').innerText = store.config.title;
        const now = new Date();
        const start = new Date(store.config.start);
        const end = new Date(store.config.end);

        // æœˆä»½è¨ˆç®—ä¿®æ­£ (1æœˆåˆ°12æœˆæ‡‰ç‚º12å€‹æœˆ)
        const totalMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
        const passedMonths = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
        const safePassed = Math.max(0, Math.min(passedMonths, totalMonths - 1));
        
        document.getElementById('mLeft').innerText = Math.max(0, totalMonths - (safePassed + 1)) + " å€‹æœˆ";
        document.getElementById('timeBar').style.width = ((safePassed + 1) / totalMonths * 100) + '%';

        const list = document.getElementById('jarList');
        const grid = document.getElementById('inputGrid');
        list.innerHTML = ""; grid.innerHTML = "";

        let totalProgress = 0;

        store.config.jars.forEach(jar => {
            const cur = store.balances[jar.name] || 0;
            const pct = jar.goal > 0 ? Math.min(Math.round((cur / jar.goal) * 100), 100) : 0;
            totalProgress += pct;
            const targetNow = Math.round((jar.goal / totalMonths) * (safePassed + 1));
            const gap = targetNow - cur;

            list.innerHTML += `
                <div class="cat-card">
                    <div style="display:flex;justify-content:space-between;font-weight:bold;margin-bottom:5px;">
                        <span>${jar.name}</span>
                        <span>${jar.unit}${cur.toLocaleString()} / ${jar.goal.toLocaleString()}</span>
                    </div>
                    <div class="prog-container"><div class="prog-text">${pct}%</div><div class="prog-fill" style="width:${pct}%"></div></div>
                    <div style="font-size:11px; color:#666; display:flex; justify-content:space-between; margin-top:5px;">
                        <span>ğŸ“ é€²åº¦æ‡‰å­˜: ${jar.unit}${targetNow.toLocaleString()}</span>
                        <span style="color:${gap > 0 ? 'var(--cat-red)' : 'var(--cat-green)'}; font-weight:bold;">${gap > 0 ? 'é‚„å·® ' + gap.toLocaleString() : 'è¶…å‰é€²åº¦ âœ¨'}</span>
                    </div>
                </div>`;
            
            grid.innerHTML += `
                <div style="border-left: 5px solid var(--cat-main); padding-left: 12px; margin-bottom: 5px;">
                    <div style="font-size:13px; font-weight:bold; margin-bottom:5px;">${jar.name} (${jar.unit})</div>
                    <input type="number" class="record-input" data-name="${jar.name}" placeholder="ä»Šå¤©å­˜å¤šå°‘ï¼Ÿ">
                </div>`;
        });
        
        // è²“å’ªè¡¨æƒ…èˆ‡ç‹€æ…‹
        const currentMonthStr = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        const hasSaved = store.history.some(h => h.time.startsWith(currentMonthStr));
        const alertEl = document.getElementById('monthly-status');
        alertEl.className = `status-alert ${hasSaved ? 'status-paid' : 'status-unpaid'}`;
        alertEl.innerHTML = hasSaved ? "âœ¨ å–µï¼æœ¬æœˆå·²ç¶“å­˜ééŒ¢äº†ï¼Œå¥½å‹¤å‹ï¼" : "âš ï¸ å–µå—š... é€™å€‹æœˆé‚„æ²’é¤µé£Ÿï¼Œè‚šå­é¤“äº†ã€‚";
        
        const avgPct = totalProgress / (store.config.jars.length || 1);
        const avatar = document.getElementById('cat-avatar');
        avatar.innerText = avgPct >= 100 ? "ğŸŠ" : avgPct >= 80 ? "ğŸ˜»" : avgPct >= 40 ? "ğŸ˜º" : avgPct > 0 ? "ğŸ±" : "ğŸ’¤";
    }

    function saveRecord() {
        let hasAnyValue = false;
        document.querySelectorAll('.record-input').forEach(input => {
            let val = Number(input.value) || 0;
            if(val !== 0) {
                const name = input.dataset.name;
                store.balances[name] = (store.balances[name] || 0) + val;
                store.history.unshift({ id: Date.now(), time: new Date().toISOString(), vals: {[name]: val} });
                hasAnyValue = true;
            }
            input.value = "";
        });
        if(hasAnyValue) {
            saveToDB();
            updateUI();
            alert("å­˜å…¥æˆåŠŸï¼å¤¢æƒ³åˆè¿‘äº†ä¸€æ­¥å–µï¼");
        }
    }

    // åŒ¯å‡ºåŠŸèƒ½
    function exportData() {
        const dataStr = JSON.stringify(store, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cat_savings_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // åŒ¯å…¥åŠŸèƒ½
    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const imported = JSON.parse(event.target.result);
                if (imported.config && imported.balances) {
                    if (confirm("åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                        store = imported;
                        saveToDB();
                        location.reload();
                    }
                } else { alert("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼"); }
            } catch (err) { alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºä¿æ˜¯æ­£ç¢ºçš„ JSON æª”æ¡ˆã€‚"); }
        };
        reader.readAsText(file);
    }

    function saveToDB() { localStorage.setItem(DB_KEY, JSON.stringify(store)); }
    function showPage(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-bar .nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pId).classList.add('active');
        if(el) el.classList.add('active');
        if(pId === 'settings') initSettingsPage();
        window.scrollTo(0,0);
    }
    function cheerUp() {
        const quotes = ["å†å­˜ä¸€é»å°±èƒ½è²·å°é­šä¹¾äº†ï¼", "éŒ¢éŒ¢æ²’æœ‰ä¸è¦‹ï¼Œåªæ˜¯è®Šæˆäº†è²“è²“çš„å½¢ç‹€", "æ¯ä¸€å¡ŠéŒ¢éƒ½æ˜¯å¤¢æƒ³çš„ç¨®å­å–µï¼", "æ‘¸æ‘¸æˆ‘ï¼Œè²¡é‹æ»¾æ»¾ä¾†ï½"];
        const b = document.getElementById('cat-bubble');
        b.innerText = quotes[Math.floor(Math.random()*quotes.length)];
        b.style.display = 'block';
        setTimeout(()=> b.style.display='none', 2000);
    }

    updateUI();
</script>
</body>
</html>
